rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    // Check if user is signed in
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of the document (userId matches auth uid)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is an Admin
    function isAdmin(appId) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/artifacts/$(appId)/users/$(request.auth.uid)).data.role == 'super_admin';
    }

    // --- Rules ---

    // 1. Slugs (Public Read, Auth Write)
    // Used to look up which user/card owns a slug
    match /artifacts/{appId}/public/data/slugs/{slug} {
      allow read: if true;
      allow write: if isAuthenticated(); // Application logic handles uniqueness, but we allow auth users to reserve
    }

    // 1.1 Custom Domains (Public Read, Auth Write)
    match /artifacts/{appId}/public/data/domains/{domain} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /artifacts/{appId}/users/{userId} {
      // Owner can read/write their own profile. Admin can access all.
      allow read, write: if isOwner(userId) || isAdmin(appId);
      
      // 3. Employees (The Digital Cards)
      match /employees/{empId} {
        // Public Read: Required for visitors to see the card
        allow read: if true;
        // Write: Only Owner or Admin, OR public update for stats (followers count)
        allow create, delete: if isOwner(userId) || isAdmin(appId);
        allow update: if isOwner(userId) || isAdmin(appId) || 
                     (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stats'])) ||
                     (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['projectManagement']) && 
                      request.resource.data.projectManagement.diff(resource.data.get('projectManagement', {})).affectedKeys().hasAny(['analytics', 'comments', 'history']));

        // 4. Products (Subcollection of Employee)
        match /products/{productId} {
          allow read: if true;
          allow write: if isOwner(userId) || isAdmin(appId);
        }

        // 4.1. Portfolio (Subcollection of Employee)
        match /portfolio/{itemId} {
          allow read: if true;
          allow write: if isOwner(userId) || isAdmin(appId);
        }

        match /leads/{leadId} {
          // Public Create: Visitors can submit forms
          // Validation: Ensure basic fields exist and are reasonably sized to prevent spam
          // For 'booking' type, we just need name and phone.
          allow create: if request.resource.data.name.size() > 0 
                      && (request.resource.data.interest.size() > 0 || request.resource.data.email.size() > 5 || request.resource.data.phone.size() > 5);
          // Read/Update/Delete: Only Owner or Admin
          allow read, update, delete: if isOwner(userId) || isAdmin(appId);
        }

        match /followers/{followerId} {
          // Public Create: Visitors can subscribe
          allow create: if request.resource.data.email.size() > 5;
          // Read/Update/Delete: Only Owner or Admin
          allow read, update, delete: if isOwner(userId) || isAdmin(appId);
        }
        
        // 5. Appointments (Public Read required for availability check)
        match /appointments/{apptId} {
          allow read: if true;
          allow create: if request.resource.data.bookingDate.size() > 0;
          allow update, delete: if isOwner(userId) || isAdmin(appId);
        }

        // 6. Analytics Events
        match /analytics_events/{eventId} {
          // Public Create: Metrics tracking
          allow create: if true;
          // Read/Update/Delete: Only Owner or Admin
          allow read, delete: if isOwner(userId) || isAdmin(appId);
          // Allow update if owner OR if only updating stats (public view counter)
          allow update: if isOwner(userId) || isAdmin(appId) || 
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stats']));
        }

        match /payment_settings/{docId} {
          // Public Read is restricted.
          allow read, write: if isOwner(userId) || isAdmin(appId);
        }
      }

      // 7. Public Info (Plan Status, etc.)
      match /public_info/{docId} {
        allow read: if true;
        allow write: if isOwner(userId) || isAdmin(appId);
      }
    }
  }
}
